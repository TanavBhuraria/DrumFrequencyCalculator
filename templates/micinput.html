<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Professional Drum Analyzer</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 800px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      width: 100%;
      position: relative;
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(90deg, #ff7e5f, #feb47b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.1);
      color: #ff7e5f;
      border: none;
      padding: 8px 16px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .back-btn:hover {
      background: rgba(255, 126, 95, 0.2);
    }
    
    .back-btn svg {
      width: 16px;
      height: 16px;
      fill: #ff7e5f;
    }
    
    .subtitle {
      font-size: 1.2rem;
      color: #a0a0d0;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .visualization {
      width: 100%;
      height: 200px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .drum-display {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 10px;
      padding: 20px;
    }
    
    .drum-pad {
      width: 70px;
      height: 70px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem;
      font-weight: bold;
      color: rgba(255, 255, 255, 0.7);
      transition: all 50ms ease-out;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      will-change: transform, background-color;
    }
    
    .drum-pad.active {
      transform: scale(1.2);
      background: rgba(255, 126, 95, 0.8);
      box-shadow: 0 0 20px rgba(255, 126, 95, 0.7);
    }
    
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    button {
      background: linear-gradient(135deg, #ff7e5f, #feb47b);
      color: white;
      border: none;
      padding: 14px 28px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 126, 95, 0.4);
      min-width: 180px;
    }
    
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(255, 126, 95, 0.6);
    }
    
    button:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      width: 100%;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .stat-card h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: #a0a0d0;
    }
    
    .stat-value {
      font-size: 3.5rem;
      font-weight: 700;
      background: linear-gradient(90deg, #ff7e5f, #feb47b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .settings {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 25px;
      width: 100%;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .slider-container {
      margin-bottom: 20px;
    }
    
    .slider-container label {
      display: block;
      margin-bottom: 10px;
      font-size: 1.1rem;
      color: #a0a0d0;
      display: flex;
      justify-content: space-between;
    }
    
    .slider-container span {
      font-weight: bold;
      color: #ff7e5f;
    }
    
    input[type="range"] {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.1);
      outline: none;
      -webkit-appearance: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #ff7e5f;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(255, 126, 95, 0.7);
    }
    
    .canvas-container {
      width: 100%;
      height: 150px;
      margin-top: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      overflow: hidden;
    }
    
    canvas {
      width: 100%;
      height: 100%;
    }
    
    .hit-indicator {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .hit-indicator.active {
      opacity: 1;
    }
    
    .harmonic-display {
      margin-top: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 15px;
      width: 100%;
    }
    
    .harmonic-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
    }
    
    .harmonic-header:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .harmonic-content {
      display: none;
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
    }
    
    .harmonic-content.show {
      display: block;
    }
    
    .harmonic-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
    }
    
    .harmonic-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      border-radius: 8px;
      text-align: center;
    }
    
    .harmonic-label {
      font-size: 0.9rem;
      color: #a0a0d0;
      margin-bottom: 5px;
    }
    
    .harmonic-value {
      font-size: 1.2rem;
      font-weight: bold;
      color: #ff7e5f;
    }
    
    .drum-info {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .drum-info-title {
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: #ff7e5f;
    }
    
    .drum-info-text {
      text-align: center;
      color: #a0a0d0;
      line-height: 1.6;
      max-width: 600px;
    }
    
    footer {
      margin-top: 40px;
      text-align: center;
      color: #777;
      font-size: 0.9rem;
      padding: 20px;
    }
    
    @media (max-width: 600px) {
      h1 {
        font-size: 2.2rem;
      }
      
      .stat-value {
        font-size: 2.8rem;
      }
      
      .drum-pad {
        width: 50px;
        height: 50px;
        font-size: 1rem;
      }
      
      button {
        min-width: 140px;
        padding: 12px 20px;
        font-size: 1rem;
      }
      
      .controls {
        gap: 10px;
      }
    }

    #debug {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      z-index: 1000;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <button class="back-btn">
        <svg viewBox="0 0 24 24">
          <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path>
        </svg>
        Back to Index
      </button>
      <h1>Professional Drum Analyzer</h1>
      <p class="subtitle">Real-time drum detection with harmonic analysis</p>
    </header>
    
    <div class="visualization">
      <div class="drum-display">
        <div class="drum-pad" data-type="kick">KICK</div>
        <div class="drum-pad" data-type="snare">SNARE</div>
        <div class="drum-pad" data-type="hihat">HI-HAT</div>
        <div class="drum-pad" data-type="tom">TOM</div>
        <div class="drum-pad" data-type="cymbal">CYMBAL</div>
      </div>
    </div>
    
    <div class="controls">
      <button id="start-btn">Start Microphone</button>
      <button id="stop-btn" disabled>Stop Microphone</button>
      <button id="reset-btn">Reset Counter</button>
    </div>
    
    <div class="stats">
      <div class="stat-card">
        <h2>Hits Detected</h2>
        <div id="hits" class="stat-value">0</div>
      </div>
      
      <div class="stat-card">
        <h2>Detected Frequency</h2>
        <div id="frequency" class="stat-value">-- Hz</div>
      </div>
    </div>
    
    <div class="settings">
      <div class="slider-container">
        <label>
          Detection Sensitivity
          <span id="sensitivity-val">0.05</span>
        </label>
        <input type="range" id="sensitivity-slider" min="0.01" max="0.15" step="0.01" value="0.05">
      </div>
      
      <div class="canvas-container">
        <canvas id="waveform"></canvas>
      </div>
    </div>
    
    <div class="harmonic-display">
      <div class="harmonic-header" id="harmonic-toggle">
        <h3>Harmonic Analysis</h3>
        <span>▼</span>
      </div>
      <div class="harmonic-content" id="harmonic-content">
        <div class="harmonic-list">
          <div class="harmonic-item">
            <div class="harmonic-label">Fundamental</div>
            <div class="harmonic-value" id="harmonic-fundamental">-- Hz</div>
          </div>
          <div class="harmonic-item">
            <div class="harmonic-label">2nd Harmonic</div>
            <div class="harmonic-value" id="harmonic-second">-- Hz</div>
          </div>
          <div class="harmonic-item">
            <div class="harmonic-label">3rd Harmonic</div>
            <div class="harmonic-value" id="harmonic-third">-- Hz</div>
          </div>
          <div class="harmonic-item">
            <div class="harmonic-label">4th Harmonic</div>
            <div class="harmonic-value" id="harmonic-fourth">-- Hz</div>
          </div>
          <div class="harmonic-item">
            <div class="harmonic-label">5th Harmonic</div>
            <div class="harmonic-value" id="harmonic-fifth">-- Hz</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="drum-info">
      <div class="drum-info-title">Drum Analysis Tips</div>
      <div class="drum-info-text">
        For best results, place your microphone near the drum and tap consistently. 
        Higher sensitivity settings work better for soft taps, while lower settings 
        are better for loud environments.
      </div>
    </div>
  </div>
  
  <div class="hit-indicator" id="hit-indicator"></div>
  <div id="debug"></div>
  
  <footer>
    <p>Professional Drum Analysis Tool | Enhanced Harmonic Detection</p>
  </footer>

  <script>
    // DOM Elements
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const resetBtn = document.getElementById('reset-btn');
    const backBtn = document.querySelector('.back-btn');
    const hitsEl = document.getElementById('hits');
    const freqEl = document.getElementById('frequency');
    const sensitivitySlider = document.getElementById('sensitivity-slider');
    const sensitivityVal = document.getElementById('sensitivity-val');
    const hitIndicator = document.getElementById('hit-indicator');
    const waveformCanvas = document.getElementById('waveform');
    const ctx = waveformCanvas.getContext('2d');
    const drumPads = document.querySelectorAll('.drum-pad');
    const harmonicToggle = document.getElementById('harmonic-toggle');
    const harmonicContent = document.getElementById('harmonic-content');
    const harmonicFundamental = document.getElementById('harmonic-fundamental');
    const harmonicSecond = document.getElementById('harmonic-second');
    const harmonicThird = document.getElementById('harmonic-third');
    const harmonicFourth = document.getElementById('harmonic-fourth');
    const harmonicFifth = document.getElementById('harmonic-fifth');
    const debugEl = document.getElementById('debug');
    
    // Audio variables
    let audioCtx = null;
    let analyser = null;
    let source = null;
    let mediaStream = null;
    let dataArray = null;
    let animationId = null;
    let noiseFloor = 0;
    
    // State variables
    let running = false;
    let hitCount = 0;
    let lastDrumType = null;
    let lastHitTime = 0;
    let lastFrequency = 0;
    const HIT_COOLDOWN = 200; // ms
    
    // Drum frequency profiles
    const drumProfiles = {
      kick: {
        range: [30, 100],
        color: '#ff5e5e',
        decay: 150,
        threshold: 0.02
      },
      snare: {
        range: [100, 300],
        color: '#5effae',
        decay: 120,
        threshold: 0.015
      },
      hihat: {
        range: [3000, 8000],
        color: '#5eb3ff',
        decay: 80,
        threshold: 0.01
      },
      tom: {
        range: [80, 200],
        color: '#ffbe5e',
        decay: 100,
        threshold: 0.018
      },
      cymbal: {
        range: [3000, 10000],
        color: '#d85eff',
        decay: 60,
        threshold: 0.008
      }
    };
    
    // Initialize UI
    sensitivityVal.textContent = sensitivitySlider.value;
    
    // Event listeners
    startBtn.addEventListener('click', startMic);
    stopBtn.addEventListener('click', stopMic);
    resetBtn.addEventListener('click', () => {
      hitCount = 0;
      hitsEl.textContent = hitCount;
    });
    
    backBtn.addEventListener('click', () => {
      window.location.href = '/index';
    });
    
    sensitivitySlider.addEventListener('input', () => {
      sensitivityVal.textContent = sensitivitySlider.value;
    });
    
    harmonicToggle.addEventListener('click', () => {
      harmonicContent.classList.toggle('show');
      harmonicToggle.querySelector('span').textContent = 
        harmonicContent.classList.contains('show') ? '▲' : '▼';
    });
    
    // Visual feedback for drum hit
    function showDrumHit(drumType) {
      const profile = drumProfiles[drumType];
      
      // Pad animation
      drumPads.forEach(pad => {
        if (pad.dataset.type === drumType) {
          pad.classList.add('active');
          setTimeout(() => pad.classList.remove('active'), profile.decay);
        }
      });
      
      // Screen flash
      hitIndicator.style.background = `radial-gradient(circle, ${profile.color}77 0%, transparent 70%)`;
      hitIndicator.classList.add('active');
      setTimeout(() => hitIndicator.classList.remove('active'), profile.decay);
    }
    
    // Draw waveform visualization
    function drawWaveform() {
      if (!analyser || !running) return;
      
      analyser.getFloatTimeDomainData(dataArray);
      
      ctx.clearRect(0, 0, waveformCanvas.width, waveformCanvas.height);
      ctx.beginPath();
      ctx.lineWidth = 1.5;
      ctx.strokeStyle = '#ff7e5f';
      ctx.filter = 'blur(0.5px)';
      
      const sliceWidth = waveformCanvas.width / bufferLength;
      let x = 0;
      
      for (let i = 0; i < bufferLength; i++) {
        const v = dataArray[i];
        const y = waveformCanvas.height/2 + (v * waveformCanvas.height/2);
        
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
        
        x += sliceWidth;
      }
      
      ctx.stroke();
      ctx.filter = 'none';
    }
    
    // Detect drum type and frequency with improved accuracy
    function detectDrum(fftData, sampleRate) {
      const now = Date.now();
      if (now - lastHitTime < HIT_COOLDOWN) return null;
      
      const fftSize = fftData.length;
      const binSize = sampleRate / analyser.fftSize;
      
      // Find the bin with the highest amplitude (skip first 10 bins to avoid DC offset)
      let maxIndex = 10;
      let maxValue = 0;
      for (let i = 10; i < fftSize / 2; i++) { // Only check first half of spectrum
        if (fftData[i] > maxValue) {
          maxValue = fftData[i];
          maxIndex = i;
        }
      }
      
      // Calculate frequency with quadratic interpolation for better accuracy
      const alpha = fftData[maxIndex - 1];
      const beta = fftData[maxIndex];
      const gamma = fftData[maxIndex + 1];
      const delta = 0.5 * (alpha - gamma) / (alpha - 2 * beta + gamma);
      const frequency = (maxIndex + delta) * binSize;
      
      // Apply threshold (convert slider value to 0-255 range)
      const threshold = parseFloat(sensitivitySlider.value) * 255;
      if (maxValue < threshold) return null;
      
      // Classify drum type based on frequency ranges
      let drumType = 'kick';
      if (frequency > 100 && frequency <= 300) drumType = 'snare';
      else if (frequency > 300 && frequency <= 800) drumType = 'tom';
      else if (frequency > 800 && frequency <= 3000) drumType = 'hihat';
      else if (frequency > 3000) drumType = 'cymbal';
      
      // Only register new hit if drum type changed or after extended cooldown
      if (drumType !== lastDrumType || now - lastHitTime > HIT_COOLDOWN * 2) {
        lastDrumType = drumType;
        lastHitTime = now;
        lastFrequency = frequency;
        return { drumType, frequency };
      }
      
      return null;
    }
    
    // Update harmonic display
    function updateHarmonicDisplay(frequency) {
      if (!frequency || frequency < 20) {
        harmonicFundamental.textContent = '-- Hz';
        harmonicSecond.textContent = '-- Hz';
        harmonicThird.textContent = '-- Hz';
        harmonicFourth.textContent = '-- Hz';
        harmonicFifth.textContent = '-- Hz';
        return;
      }
      
      harmonicFundamental.textContent = `${frequency.toFixed(0)} Hz`;
      harmonicSecond.textContent = `${(frequency * 2).toFixed(0)} Hz`;
      harmonicThird.textContent = `${(frequency * 3).toFixed(0)} Hz`;
      harmonicFourth.textContent = `${(frequency * 4).toFixed(0)} Hz`;
      harmonicFifth.textContent = `${(frequency * 5).toFixed(0)} Hz`;
    }
    
    // Audio processing loop
    function processAudio() {
      if (!running) return;

      // Get FFT data
      const fftData = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(fftData);
      
      // Calculate TOTAL energy (0-255 scale)
      let totalEnergy = 0;
      for (let i = 0; i < fftData.length; i++) {
        totalEnergy += fftData[i];
      }
      const avgEnergy = totalEnergy / fftData.length;

      // Update debug display
      debugEl.textContent = `Energy: ${avgEnergy.toFixed(1)} (Noise: ${noiseFloor.toFixed(1)})`;

      // Skip if below noise floor
      if (avgEnergy < noiseFloor) {
        drawWaveform();
        animationId = requestAnimationFrame(processAudio);
        return;
      }

      // Rest of detection logic
      const detectionResult = detectDrum(fftData, audioCtx.sampleRate);
      
      if (detectionResult) {
        hitCount++;
        hitsEl.textContent = hitCount;
        freqEl.textContent = `${detectionResult.frequency.toFixed(0)} Hz (${detectionResult.drumType.toUpperCase()})`;
        updateHarmonicDisplay(detectionResult.frequency);
        showDrumHit(detectionResult.drumType);
      }
      
      drawWaveform();
      animationId = requestAnimationFrame(processAudio);
    }
    
    // Start microphone processing
    async function startMic() {
      if (running) return;
      
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // Add compressor for better dynamics
        const compressor = audioCtx.createDynamicsCompressor();
        compressor.threshold.value = -30;
        compressor.knee.value = 20;
        compressor.ratio.value = 12;
        compressor.attack.value = 0.003;
        compressor.release.value = 0.25;
        
        // Add low-pass filter specifically for kick detection
        const lowpass = audioCtx.createBiquadFilter();
        lowpass.type = "lowpass";
        lowpass.frequency.value = 150;
        
        // Get microphone
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        source = audioCtx.createMediaStreamSource(mediaStream);
        
        // Setup analyser with higher resolution
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 4096; // Higher resolution for low frequencies
        bufferLength = analyser.frequencyBinCount;
        dataArray = new Float32Array(bufferLength);

        // Calibrate noise floor (1 second)
        noiseFloor = 0;
        for (let i = 0; i < 10; i++) {
          const fftData = new Uint8Array(analyser.frequencyBinCount);
          analyser.getByteFrequencyData(fftData);
          noiseFloor += fftData.reduce((a,b) => a + b, 0) / fftData.length;
          await new Promise(r => setTimeout(r, 100));
        }
        noiseFloor = noiseFloor / 10 * 1.5; // 50% safety margin

        source.connect(compressor);
        compressor.connect(lowpass);
        lowpass.connect(analyser);

        if (audioCtx.state === 'suspended') await audioCtx.resume();
        
        running = true;
        hitCount = 0;
        hitsEl.textContent = '0';
        freqEl.textContent = '-- Hz';
        updateHarmonicDisplay(0);
        
        startBtn.disabled = true;
        stopBtn.disabled = false;
        
        harmonicContent.classList.add('show');
        harmonicToggle.querySelector('span').textContent = '▲';
        
        processAudio();
      } catch (err) {
        console.error("Audio setup failed:", err);
        alert("Couldn't access microphone. Please check permissions and try again.");
        stopMic();
      }
    }
    
    // Stop microphone processing
    function stopMic() {
      running = false;
      cancelAnimationFrame(animationId);
      
      if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
      if (source) source.disconnect();
      if (analyser) analyser.disconnect();
      if (audioCtx?.state !== 'closed') audioCtx?.close();
      
      startBtn.disabled = false;
      stopBtn.disabled = true;
      ctx.clearRect(0, 0, waveformCanvas.width, waveformCanvas.height);
    }
    
    // Initialize canvas
    function initCanvas() {
      waveformCanvas.width = waveformCanvas.offsetWidth;
      waveformCanvas.height = waveformCanvas.offsetHeight;
    }
    
    window.addEventListener('load', initCanvas);
    window.addEventListener('resize', initCanvas);
    window.addEventListener('beforeunload', stopMic);
  </script>
</body>
</html>